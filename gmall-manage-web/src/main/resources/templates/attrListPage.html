<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<table id="dg" class="easyui-datagrid" title="平台属性列表-lhd" style="width:100%;height:250px"
       data-options="toolbar:'#td',singleSelect:true,collapsible:true">
    <thead>
    <tr>
        <th data-options="field:'id',width:200">平台属性ID</th>
        <th data-options="field:'attrName',width:200">平台属性名称</th>
    </tr>
    </thead>
    <div id="tb">
        <a href="javascript:addAttrInfo();" class="easyui-linkbutton" data-options="iconCls:'icon-add',plain:true">新增</a>
        <a href="#" class="easyui-linkbutton" data-options="iconCls:'icon-edit',plain:true">修改</a>
        <a href="#" class="easyui-linkbutton" data-options="iconCls:'icon-remove',plain:true">删除</a>
    </div>
    <!--<div>-->
        <!--一级类目:<select id="ctg1ForAttrList" data-options="valueField:'id',-->
                                                            <!--textField:'name',-->
                                                            <!--url:'getCatalog1',-->
                                                            <!--onSelect: function(rec){-->
                                                                    <!--$('#ctg2ForAttrList').combobox('clear');-->
                                                                    <!--$('#ctg3ForAttrList').combobox('clear');-->
                                                                    <!--var url = 'getCatalog2?c1id='+rec.id;-->
                                                                    <!--$('#ctg2ForAttrList').combobox('reload', url);-->
                                                                    <!--}-->
                                                            <!--"-->
                     <!--class="easyui-combobox" name="dept" style="width:100px;"></select>-->
        <!--二级类目:<select id="ctg2ForAttrList" data-options="valueField：'id'，-->
                                                            <!--textField：'name'，-->
                                                            <!--onSelect: function(rec){-->
                                                                    <!--$('#ctg3ForAttrList').combobox('clear');-->
                                                                    <!--var url = 'getCatalog3?c2id='+rec.id;-->
                                                                    <!--$('#ctg3ForAttrList').combobox('reload', url);-->
                                                                    <!--}-->
                                                            <!--"-->
                     <!--class="easyui-combobox" name="dept" style="width:100px;"></select>-->
        <!--三级类目:<select id="ctg3ForAttrList" data-options="valueField：'id'，-->
                                                            <!--textField：'name'-->
                                                            <!--"-->
                     <!--class="easyui-combobox" name="dept" style="width:100px;"></select>-->
    <!--</div>-->
    <div>
        一级分类:<select data-options="url:'getCatalog1',valueField:'id',textField:'name',
                onSelect: function(rec){
                    $('#ctg2ForAttrList').combobox('clear');
                    $('#ctg3ForAttrList').combobox('clear');
                    var url = 'getCatalog2?c1id='+rec.id;
                    $('#ctg2ForAttrList').combobox('reload', url);
                }" id="ctg1ForAttrList"  class="easyui-combobox" name="state" style="width:100px;"></select>
        二级分类:<select data-options="valueField:'id',textField:'name',
             onSelect: function(rec){
                                $('#ctg3ForAttrList').combobox('clear');
                                var url = 'getCatalog3?c2id='+rec.id;
                                $('#ctg3ForAttrList').combobox('reload', url);
                            }
           " id="ctg2ForAttrList"class="easyui-combobox" name="state" style="width:100px;"></select>
        三级分类:<select data-options="valueField:'id',textField:'name'," id="ctg3ForAttrList"class="easyui-combobox" name="state" style="width:100px;"></select>

        <a href="javascript:reloadAttrList();"  class="easyui-linkbutton" data-options="iconCls:'icon-search'">刷新属性列表</a>
    </div>
</table>
<!--
   --------------------------------------------------dialog 弹框-------------------------------------------
   -->
<div id="dd" class="easyui-dialog" title="属性编辑" style="width:600px;height:500px;" data-options="closed: 'true',iconCls:'icon-save',resizable:true,modal:true" buttons="#bb">
    <form id="attrForm">
        <br/>
        <label>属性名称:</label>
        <input  id="attrName" name="attrName" class="easyui-textbox" data-options="" style="width:100px"/>
        <input  id="attrId" name="attrId" type="hidden"  />
        <br/><br/>
        <table id="dg_av" class="easyui-datagrid" title="属性值列表"></table>
    </form>

</div>
<div id="bb">
    <a href="javascript:attr_save();" class="easyui-linkbutton">保存</a>
    <a href="#" class="easyui-linkbutton">关闭</a>
</div>
<script language="JavaScript">

    /*
    *   根据三级类目id查询商品属性列表
    *
    * */
    function reloadAttrList() {
        //获取三级类目id
        var c3id = $("#ctg3ForAttrList").combobox("getValue");
        //根据id发送请求
        $("#dg").datagrid({
            url:"getAttrBaseInfoByC3id?c3id="+c3id
        })
    }
    //点击添加按钮,根据三级类目id BaseAttrInfo中插入数据，需要三级类目id的值
    function addAttrInfo() {
        //获取三级类目id
        var c3id = $("#ctg3ForAttrList").combobox("getValue");
        if(c3id){
           alert("添加属性列表")
        }else{
           var c3id = "1";
        }
        $("#dd").dialog("open");
        initAttrValueDatagrid();

    }
    //初始化datagrid
    function initAttrValueDatagrid() {
        datagrid = $('#dg_av').datagrid({
            toolbar: [{
                iconCls: 'icon-add',
                handler: function(){
                    //追加一行属性值列表
                    $('#dg_av').datagrid('appendRow',{
                        id: '',
                        valueName: "kkkkk"
                    });
                }
            },'-',{
                iconCls: 'icon-edit',
                handler: function(){alert('edit')}
            },'-',{
                iconCls: 'icon-remove',
                handler: function(){
                    //删除选中的列  先获取被选择的列
                   var selectRow =  $('#dg_av').datagrid("getSelected");
                   //获取行号
                    var index =  $('#dg_av').datagrid("getRowIndex",selectRow);
                    //执行删除
                    $('#dg_av').datagrid("deleteRow",index);
                }
            }],
            columns:[[
                {field:'id',title:'属性值编号',width:100},
                {field:'valueName',title:'属性值名称',width:100,editor:{
                        type:"validatebox",
                        options:{
                            required:true
                        }
                    }},
            ]],
            onDblClickRow:function(rowIndex, rowData){
                //双击开启编辑行
                datagrid.datagrid("beginEdit", rowIndex);
                //设定当失去焦点时,退出编辑状态
                var valueName = rowData.valueName;
                $("input.datagrid-editable-input").val(valueName).bind("blur",function(evt){
                    datagrid.datagrid('endEdit',rowIndex);
                });
            }
        });

    }
    //点击新增按钮 新增操作
    function attr_save() {

        var baseInfo = {};

        var catalog3Id = $("#ctg3ForAttrList").combobox("getValue");
        baseInfo["catalog3Id"] = catalog3Id;
        //第一步      获取属性名称
        var attrName =  $("#attrName").textbox("getText");
        baseInfo["attrName"] = attrName;
        //第二步      获取datagrid 属性值  需考虑提交多个属性值的情况
        var rows = $("#dg_av").datagrid("getRows");
        $(rows).each(function(i,json){
            var valueName = json.valueName;
            baseInfo["attrValueList["+i+"].valueName"] = valueName;
        });

        //第三步     异步提交使用ajax
        $.post(
            "saveAttr",
            baseInfo,
            function(data){

            }
        );
        $("#dd").dialog("close");
    }
</script>

</body>
</html>